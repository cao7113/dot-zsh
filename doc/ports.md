# Detect ports

在探测目标主机（特别是像 Ubuntu 这样的 Linux 系统）可用的端口时，我们通常分为**“内部查看”**和**“外部扫描”**两种场景。

### 1. 内部查看：在目标机器上自检

如果你已经通过 `orb ssh` 进入了 Ubuntu，最快的方法是查看内核目前正在监听哪些端口。

- **使用 `ss` 命令（最现代、推荐）：**

```bash
# -t: TCP, -u: UDP, -l: 仅显示监听状态, -p: 显示进程名, -n: 数字格式显示端口
sudo ss -tulpn

```

- **使用 `netstat`（老牌但常用）：**

```bash
sudo netstat -tulpn

```

- **使用 `lsof`（查看具体文件/端口占用）：**

```bash
sudo lsof -i -P -n | grep LISTEN

```

---

### 2. 外部探测：从另一台机器扫描

如果你在 Mac 宿主机上，想知道 OrbStack 容器暴露了哪些端口，可以使用以下工具：

#### A. Nmap (功能最全)

这是网络扫描的标准工具。如果没安装，可以用 `brew install nmap`。

- **扫描常见端口：**

```bash
nmap [目标IP或主机名]

```

- **扫描指定端口（如 22, 80, 443）：**

```bash
nmap -p 22,80,443 [目标IP]

```

- **全端口扫描（1-65535）：**

```bash
nmap -p- [目标IP]

```

#### B. Netcat (nc) - 快速检测

如果你只想快速知道某个特定端口（比如 22）是否通畅：

```bash
# -z: 仅扫描不发送数据, -v: 显示详细输出, -w: 超时时间
nc -zv [目标IP] 22

```

---

### 3. 特别注意：OrbStack 的端口映射

对于 OrbStack 的 Machine，端口表现与传统服务器略有不同：

1. **localhost 转发：** 默认情况下，如果你在 Ubuntu 内部运行了一个服务（如 Nginx 在 80 端口），OrbStack 会自动将其映射到 Mac 的 `localhost:80`。你可以直接在 Mac 上用 `nc -zv localhost 80` 探测。
2. **22 端口：** 就像我们之前讨论的，OrbStack 默认不开启 `sshd`，所以 `nmap` 扫描 22 端口通常会显示 `closed`。

### 总结常用探测方法

| 方法         | 命令                 | 适用场景                 |
| ------------ | -------------------- | ------------------------ |
| **自检**     | `ss -tulpn`          | 确认服务是否启动成功     |
| **快速探测** | `nc -zv <IP> <Port>` | 检查特定端口通不通       |
| **全面扫描** | `nmap <IP>`          | 发现主机上所有开放的服务 |

**如果你发现某个端口（比如 80）明明在 Ubuntu 里显示 LISTEN，但在 Mac 浏览器里打不开，需要我帮你排查是防火墙（ufw）的问题还是监听地址（0.0.0.0 vs 127.0.0.1）的问题吗？**

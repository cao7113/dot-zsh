# typeset and functions

在 Zsh 中，`typeset` 和 `functions` 是两个极其核心的内置命令。它们不仅是用来“定义”变量或函数的工具，更是 Zsh 这种高级 Shell 能够实现**类型检查、属性控制和自动加载**的基础。

---

## 1. 深入理解 `typeset`：变量的“属性管理器”

在基础 Shell 脚本中，变量通常是无类型的字符串。但在 Zsh 中，`typeset` 赋予了变量类似编程语言的特性。

### 核心能力

`typeset` 的主要作用是设置变量的**作用域**、**类型**和**格式**。

- **作用域控制**：在函数内部使用 `typeset` 定义的变量默认是**局部变量**（Local），不会污染全局环境。
- **强制类型转换**：
- `typeset -i var`：声明为**整数**。即使赋值 `"10"`，它也会存为数字。
- `typeset -F var`：声明为**浮点数**。
- `typeset -a var`：声明为**数组**（Array）。
- `typeset -A var`：声明为**关联数组**（Map/Dictionary），这是 Zsh 非常强大的功能。

### 格式化魔法

`typeset` 还能控制输出格式：

- `typeset -L 5 var`：左对齐，宽度为 5（自动截断或补齐空格）。
- `typeset -u var`：自动转为**大写**。
- `typeset -l var`：自动转为**小写**。

### 唯一性约束（最常用）

```zsh
typeset -U path

```

这个命令非常关键。`-U` (Unique) 告诉 Zsh：这个数组里的元素必须是**唯一**的。当你多次运行 `path+=('/usr/local/bin')` 时，Zsh 会自动检查去重，防止你的 `$PATH` 变成一长串重复的垃圾。

---

## 2. 深入理解 `functions`：不仅仅是定义

`functions` 本质上是 `typeset -f` 的别名，专门用于处理 Shell 函数。

### 函数的“生命周期”管理

Zsh 的函数处理比 Bash 复杂且高效得多：

1. **定义与读取**：
   当你输入 `functions name`，Zsh 会从内存中提取该函数的解析树并重新格式化为易读的代码。这证明了 Zsh 存储的是“编译后”的逻辑，而非简单的文本。
2. **粘滞作用域 (Sticky Scope)**：
   使用 `functions -z name` 可以标记一个函数在执行时使用 Zsh 的仿真模式（如模拟 sh 或 ksh），这在运行旧脚本时非常有用。
3. **自动加载（Autoloading）**：
   这是 Zsh 性能强大的秘诀。通过 `autoload -Uz func_name`，你并没有真正把函数代码加载到内存里，只是告诉 Zsh：“当有人调用 `func_name` 时，去 `$fpath` 目录里找同名文件并执行”。

---

## 3. `typeset` 与 `functions` 的联动

你可以通过 `typeset` 来修改函数的行为：

- **追踪执行**：
  `typeset -ft my_func`（f 代表 function，t 代表 trace）。
  这会开启该函数的**追踪模式**。当你调用 `my_func` 时，终端会打印出该函数执行的每一步细节，而不会影响其他函数的运行。这是调试神器。
- **只读函数**：
  `typeset -fr my_func`。
  将函数设为只读，防止在复杂的脚本执行过程中被无意间覆盖。

---

## 4. 总结对比

| 特性         | `typeset` (变量/通用)              | `functions` (仅限函数)     |
| ------------ | ---------------------------------- | -------------------------- |
| **本质**     | 声明/修改 shell 对象的属性         | `typeset -f` 的快捷方式    |
| **主要参数** | `-i`(整型), `-A`(字典), `-U`(唯一) | `-u`(标记加载), `-t`(追踪) |
| **作用域**   | 默认为 Local（在函数内使用时）     | 全局（除非特殊处理）       |
| **典型用途** | 规范化 `$PATH` 或定义复杂数据结构  | 调试函数逻辑或管理自动加载 |

---

### 一个实战技巧

如果你想查看当前 Shell 环境中哪些变量是“特殊”的（比如带唯一性检查或只读），可以运行：

```zsh
typeset -p | grep "path"

```

这会显示该变量的所有原始定义参数（如 `typeset -aUT /usr/bin path`）。

**你是否想尝试用 `typeset -A` 创建一个类似字典的配置对象，用来优化你的 Taskfile 或脚本逻辑？**
